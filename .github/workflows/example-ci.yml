# GitHub Actions CI/CD 예시
# 
# 이 파일은 GitHub Actions에서 API 키를 안전하게 사용하는 방법을 보여줍니다.
# 실제 사용 시에는 이 파일을 .github/workflows/ci.yml로 복사해서 사용하세요.

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest supabase  # 테스트 및 Supabase 클라이언트
    
    - name: Run tests
      env:
        # GitHub Secrets에서 API 키 가져오기
        # Settings → Secrets and variables → Actions → New repository secret
        # 이름: GEMINI_API_KEY, 값: 실제 API 키
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        pytest tests/ -v
    
    - name: Run sample analysis
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python scripts/run_sample_analysis.py "새우깡 5,000봉지 미국에 4달러에 팔거야"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for leaked secrets
      # 실제 API 키만 검사 (더미 키, 문서 예시, 패턴 설명 제외)
      run: |
        echo "Checking for leaked API keys..."
        # 실제 API 키 패턴 검사 (39자 이상의 실제 키만)
        # 제외: 테스트 더미 키, 문서 예시, 패턴 설명
        # tests/ 디렉토리와 문서 파일은 제외
        if grep -r "AIzaSy[A-Za-z0-9_-]\{35,\}" \
          --include="*.py" \
          --include="*.yml" \
          --exclude-dir=tests \
          --exclude="*example*.yml" \
          . | grep -v "DummyKeyForTesting" | grep -v "AIzaSy\.\.\." | grep -v "AIzaSyXXXX" | grep -v "YOUR_GEMINI_API_KEY" | grep -v "TEST_DUMMY"; then
          echo "⚠️  WARNING: Potential API key found in code!"
          exit 1
        fi
        echo "✅ No leaked API keys found"

