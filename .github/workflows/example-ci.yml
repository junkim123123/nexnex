# GitHub Actions CI/CD 예시
# 
# 이 파일은 GitHub Actions에서 API 키를 안전하게 사용하는 방법을 보여줍니다.
# 실제 사용 시에는 이 파일을 .github/workflows/ci.yml로 복사해서 사용하세요.

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest supabase  # 테스트 및 Supabase 클라이언트
    
    - name: Run tests
      env:
        # GitHub Secrets에서 API 키 가져오기
        # Settings → Secrets and variables → Actions → New repository secret
        # 이름: GEMINI_API_KEY, 값: 실제 API 키
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        pytest tests/ -v
    
    - name: Run sample analysis
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python scripts/run_sample_analysis.py "새우깡 5,000봉지 미국에 4달러에 팔거야"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for leaked secrets
      # gitleaks 같은 도구로 키 노출 검사
      run: |
        echo "Checking for leaked API keys..."
        # 실제로는 gitleaks 같은 도구 사용 권장
        if grep -r "AIzaSy" --include="*.md" --include="*.py" --include="*.yml" .; then
          echo "⚠️  WARNING: Potential API key found in code!"
          exit 1
        fi

